<template>
  <div class="set-asset">
    <!-- 1.ëª©í‘œê¸ˆì•¡ ì„¤ì • 2.ê° ìì‚°ë“¤ ì„¤ì • -->
    <h3 class="font-jua">ëª©í‘œ ê¸ˆì•¡ ì„¤ì • - ê°œì¸ì‘ì—…ìš©</h3>
    <b class="explanation">* ëª¨ë“  ê¸ˆì•¡ì€ ìˆ«ìë§Œ ê¸°ì…í•´ ì£¼ì„¸ìš”</b>
    <form action="">
      <div action="" class="total-goal-cont">
        <strong>ì´ ëª©í‘œ ê¸ˆì•¡</strong>
        <input
          type="text"
          placeholder="ì´ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"
          v-model="saveAsset.assets.totalGoal"
        />
      </div>

      <div action="" class="money-goal-cont">
        <strong>í˜„ê¸ˆ ëª©í‘œ ê¸ˆì•¡</strong>
        <input
          type="text"
          placeholder="í˜„ê¸ˆ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"
          v-model="saveAsset.assets.cashGoal"
        />
      </div>

      <div action="" class="money-asset-cont">
        <strong>í˜„ê¸ˆ ìì‚°</strong>
        <input
          type="text"
          placeholder="í˜„ê¸ˆ ìì‚°ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"
          v-model="saveAsset.assets.cashAsset"
        />
      </div>

      <div action="" class="credit-goal-cont">
        <strong>ì€í–‰ ë³„ ìì‚° ì…ë ¥</strong>
        <!-- <b class="explanation" v-if="getBanks.length === 0">
          ( ìš°ì¸¡ <span>+</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì€í–‰ ë³„ ìì‚° ì…ë ¥ì°½ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.
          )
        </b> -->
        <b class="explanation" v-if="bankLength !== 0">
          <!-- ì €ì¥ë˜ì–´ ìˆëŠ” ì€í–‰ ê°œìˆ˜ë¥¼ ë¶ˆëŸ¬ì™€ì•¼ í•˜ê¸° ë•Œë¬¸ì— firebaseì— ì €ì¥ë˜ì–´ìˆëŠ” banksì˜ lengthë¥¼ ì´ìš©. -->
          ( í˜„ì¬ {{ bankLength }}ê°œì˜ ì€í–‰ ìì‚°ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.)
          <!-- ( í˜„ì¬ {{ getBanks.length }}ê°œì˜ ì€í–‰ ìì‚°ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.) -->
        </b>
        <button @click.prevent="clickAddBank()">+</button>
        <ul>
          <li class="explanationLi" v-if="saveAsset.banks.length === 0">
            <!-- ì…ë ¥ì°½ì´ í•˜ë‚˜ë¼ë„ ìƒì„±ë˜ë©´ ì•ˆë‚´ê¸€ì„ ì‚¬ë¼ì§€ê²Œ í•´ì•¼í•˜ë¯€ë¡œ, saveAssetì˜ banks ê¸¸ì´ë¥¼ ì´ìš© -->
            <span class="explanation">
              ìš°ì¸¡ <span>+</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì€í–‰ ë³„ ìì‚° ì…ë ¥ì°½ì„ ì¶”ê°€í•´
              ì£¼ì„¸ìš”.
            </span>
          </li>
          <li v-for="bankList in saveAsset.banks" :key="bankList.id">
            <select name="bank" v-model="bankList.bank">
              <option value="">ì€í–‰ì„ íƒ</option>
              <option value="ê²½ë‚¨ì€í–‰">ê²½ë‚¨ì€í–‰</option>
              <option value="ê´‘ì£¼ì€í–‰">ê´‘ì£¼ì€í–‰</option>
              <option value="êµ­ë¯¼ì€í–‰">êµ­ë¯¼ì€í–‰</option>
              <option value="ê¸°ì—…ì€í–‰">ê¸°ì—…ì€í–‰</option>
              <option value="ë†í˜‘">ë†í˜‘</option>
              <option value="ëŒ€êµ¬ì€í–‰">ëŒ€êµ¬ì€í–‰</option>
              <option value="ë¶€ì‚°ì€í–‰">ë¶€ì‚°ì€í–‰</option>
              <option value="ì‚°ì—…ì€í–‰">ì‚°ì—…ì€í–‰</option>
              <option value="ì €ì¶•ì€í–‰">ì €ì¶•ì€í–‰</option>
              <option value="ìƒˆë§ˆì„ê¸ˆê³ ">ìƒˆë§ˆì„ê¸ˆê³ </option>
              <option value="ìˆ˜í˜‘ì¤‘í•­íšŒ">ìˆ˜í˜‘ì¤‘í•­íšŒ</option>
              <option value="ì‹ í˜‘">ì‹ í˜‘</option>
              <option value="ì‹ í•œì€í–‰">ì‹ í•œì€í–‰</option>
              <option value="ìš°ë¦¬ì€í–‰">ìš°ë¦¬ì€í–‰</option>
              <option value="ìš°ì²´êµ­">ìš°ì²´êµ­</option>
              <option value="ì „ë¶ì€í–‰">ì „ë¶ì€í–‰</option>
              <option value="ì œì£¼ì€í–‰">ì œì£¼ì€í–‰</option>
              <option value="ì¹´ì¹´ì˜¤ë±…í¬">ì¹´ì¹´ì˜¤ë±…í¬</option>
              <option value="ì¼€ì´ë±…í¬">ì¼€ì´ë±…í¬</option>
              <option value="í•˜ë‚˜ì€í–‰">í•˜ë‚˜ì€í–‰</option>
              <option value="í•œêµ­ì”¨í‹°ì€í–‰">í•œêµ­ì”¨í‹°ì€í–‰</option>
              <option value="SCì œì¼ì€í–‰">SCì œì¼ì€í–‰</option>
            </select>
            <input
              type="text"
              placeholder="í•´ë‹¹ ì€í–‰ì˜ ì´ ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”"
              v-model="bankList.asset"
            />
            <span class="realTimeAsset"
              >( í˜„ì¬ {{ assetAddComma(bankList.asset) }}ì› ë‚¨ìŒ )</span
            >
            <!-- <button class="edit">ìˆ˜ì •</button> -->
            <button
              class="btn small remove"
              @click.prevent="clickRemoveBank(bankList)"
            >
              âœ•
            </button>
          </li>
        </ul>
      </div>
      <button
        class="btn small"
        v-if="
          this.$store.state.total === '' &&
            this.$store.state.cash === '' &&
            this.$store.state.bankAsset.bank === '' &&
            this.$store.state.bankAsset.asset === 0
        "
        @click.prevent="clickSaveAsset()"
      >
        ì„¤ì •
      </button>
      <button
        class="btn small"
        v-if="
          this.$store.state.total !== '' ||
            this.$store.state.cash !== '' ||
            this.$store.state.bankAsset.bank !== '' ||
            this.$store.state.bankAsset.asset !== 0
        "
        @click.prevent="clickSaveAsset()"
      >
        ìˆ˜ì •
      </button>
    </form>
  </div>
</template>

<script>
import { makeID, addComma } from '@/utils/filters.js';
import { moneybooRef, settingColRef } from '@/api/firestore';
import firebase from 'firebase';

export default {
  data() {
    return {
      // 'ì…ë ¥í•œ ê°’', 'firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ ì €ì¥ëœ ê°’' ëª¨ë‘ saveAsset ì´ìš©.
      saveAsset: {
        assets: {
          totalGoal: '',
          cashGoal: '',
          cashAsset: '',
        },
        banks: [],
      },
      bankLength: 0, // ì €ì¥ëœ ì€í–‰ ê°œìˆ˜ ìœ„í•´ í•„ìš”.
      currentUid: this.$store.state.uid, // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ uid
    };
  },
  created() {
    // ***********ì½”ë“œ ì—°êµ¬ì¤‘....**********
    console.log(this.saveAsset.banks);
    let saveAssetBank = this.saveAsset.banks;
    console.log(saveAssetBank);
    console.log(saveAssetBank.length);
    console.log(...this.saveAsset.banks);
    console.log(typeof this.saveAsset.banks);
    console.log(this.saveAsset.banks.length);
    console.log(JSON.parse(JSON.stringify(this.saveAsset.banks)));
    this.$root.log = function log() {
      for (let i = 0; i < saveAssetBank.length; i++) {
        console.log('hgello');
        console.log(saveAssetBank.length);
        if (typeof saveAssetBanks === 'object') {
          try {
            saveAssetBank[i] = JSON.parse(JSON.stringify(saveAssetBank));
          } catch (error) {
            console.log(error);
          }
        }
      }
      console.log(...saveAssetBank);
    };
    // ************************

    // í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ì€í–‰ ë³„ ìì‚° ì…ë ¥ ì¹¸ í•˜ë‚˜ ìƒì„±ì‹œì¼œì¤Œ.
    if (this.saveAsset.banks === []) {
      this.saveAsset.banks.push({ bank: '', asset: '', id: '' });
    }

    // // cookieì— ì €ì¥ ëœ ì€í–‰ ë³„ ìì‚° ë¶ˆëŸ¬ì˜´.
    // for (let i = 0; i < this.$store.state.bankAsset.bank.length; i++) {
    //   // 1) cookieì— ì €ì¥ëœ ì€í–‰ ìˆ˜ë§Œí¼ í™”ë©´ì— ìƒì ìƒê¸°ê²Œ í•´ì¤Œ.
    //   this.saveAsset.banks.push({ bank: '', asset: '', id: '' });
    //   // 2) ì€í–‰ëª…, ì€í–‰ë³„ ìì‚°, ì€í–‰ë³„ ì•„ì´ë”” ê°ê° ë„£ì–´ì¤Œ.
    //   this.saveAsset.banks[i].bank = this.$store.state.bankAsset.bank[i];
    //   this.saveAsset.banks[i].asset = this.$store.state.bankAsset.asset[i];
    //   this.saveAsset.banks[i].id = this.$store.state.bankAsset.id[i];
    //   console.log(this.$store.state.bankAsset.id[i]);
    // }

    // ì €ì¥ëœ ì€í–‰ ìˆ˜ dataì— ë„£ì–´ì¤Œ.
    this.bankNum = this.$store.state.bankAsset.bank.length;

    // firstoreì—ì„œ asset DB ê°€ì ¸ì˜¤ê¸°
    // --- assets
    this.settingListRef()
      .doc('assets')
      .onSnapshot(snapshot => {
        // console.log(snapshot.data().setAsset);
        // documentì˜ ê°’ì´ ìˆìœ¼ë©´
        if (snapshot.exists) {
          const assets = snapshot.data().assets;
          console.log(assets);
          if (assets) {
            this.saveAsset.assets.totalGoal = assets.totalGoal;
            this.saveAsset.assets.cashAsset = assets.cashAsset;
            this.saveAsset.assets.cashGoal = assets.cashGoal;
          }
        }
      });

    // --- banks
    this.settingListRef()
      .doc('banks')
      .onSnapshot(snapshot => {
        // console.log(snapshot.data().setAsset);
        // documentì˜ ê°’ì´ ìˆìœ¼ë©´
        if (snapshot.exists) {
          const banks = snapshot.data().banks;
          if (banks) {
            this.saveAsset.banks = banks;
            this.bankLength = banks.length;
          }
        }
      });
    // this.mbooRef()
    //   .doc('settings')
    //   .get()
    //   .then(docSnapshot => {
    //     // documentì˜ ê°’ì´ ìˆìœ¼ë©´
    //     if (docSnapshot.exists) {
    //       const setAsset = docSnapshot.data().setAsset;

    //       // setAsset ë°ì´í„°ê°€ ìˆìœ¼ë©´
    //       if (setAsset) {
    //         // ë¶ˆëŸ¬ì˜¨ ëª©í‘œê¸ˆì•¡,í˜„ê¸ˆìì‚° getAsset ê°ì²´ì— ì €ì¥
    //         this.saveAsset.assets.totalGoal = setAsset.assets.totalGoal;
    //         this.saveAsset.assets.cashAsset = setAsset.assets.cashAsset;
    //         this.saveAsset.assets.cashGoal = setAsset.assets.cashGoal;

    //         // ë¶ˆëŸ¬ì˜¨ ì€í–‰ ìì‚°ë“¤ getBanksì— ì €ì¥
    //         setAsset.banks.forEach(data => {
    //           this.saveAsset.banks.push(data);
    //           this.getBanks.push(data);
    //         });

    //         // setAsset ë°ì´í„°ê°€ ì—†ìœ¼ë©´
    //       } else {
    //         this.logMassage = 'ìì‚°ê³¼ ëª©í‘œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
    //         console.log('setAsset ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!', docSnapshot);
    //       }

    //       // document ê°’ì´ ì—†ìœ¼ë©´
    //     } else {
    //       console.log('settings ê°’ì´ ì—†ìŒ', docSnapshot);
    //       this.logMassage = 'ì…‹íŒ… ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
    //     }
    //   })
    //   .catch(err => {
    //     console.log(err);
    //   });

    // // í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ì€í–‰ ë³„ ìì‚° ì…ë ¥ ì¹¸ í•˜ë‚˜ ìƒì„±ì‹œì¼œì¤Œ.
    // // if (this.saveAsset.banks === []) {
    // this.saveAsset.banks.push({ bank: '', asset: '', id: '' });
    // // }

    // firstoreì—ì„œ asset DB ê°€ì ¸ì˜¤ê¸°
    this.getFirebase();
  },
  computed: {},
  methods: {
    mbooRef() {
      return moneybooRef(this.currentUid);
    },
    clickAddBank() {
      this.saveAsset.banks.push({ bank: '', asset: '', id: makeID('bank') });
    },
    clickRemoveBank(bankList) {
      console.log(bankList);
      this.settingListRef()
        .doc('banks')
        .update({ banks: firebase.firestore.FieldValue.arrayRemove(bankList) });
    },
    // --------0826 setting êµ¬ì¡° ë°”ê¿ˆ (í™•ì¸í•˜ì‹œê³  ì‚­ì œë¶€íƒë“œë¦½ë‹ˆë‹¤!) ğŸ˜€
    // settings document > settingList collection ì°¸ì¡°ê°’
    settingListRef() {
      return settingColRef(this.currentUid);
    },
    clickSaveAsset() {
      // --------0826 setting êµ¬ì¡° ë°”ê¿ˆ (í™•ì¸í•˜ì‹œê³  ì‚­ì œë¶€íƒë“œë¦½ë‹ˆë‹¤!) ğŸ˜€
      // ì—ì…‹ë¦¬ìŠ¤íŠ¸ ì €ì¥
      this.saveAssetListForm();
      // bank ì €ì¥
      this.setBankListForm();

      // --- assets
      // this.settingListRef()
      //   .doc('assets')
      //   .get()
      //   .then(docSnapshot => {
      //     // documnetê°€ ìˆìœ¼ë©´ update
      //     console.log(docSnapshot);
      //     if (docSnapshot.exists) {
      //       this.settingListRef()
      //         .doc('assets')
      //         .update({ assets: this.saveAsset.assets });

      //       // documentê°€ ì—†ìœ¼ë©´ set
      //     } else {
      //       this.settingListRef()
      //         .doc('assets')
      //         .update({ assets: this.saveAsset.assets });
      //       this.logMassage = ''; // ë°ì´í„°ë¥¼ ì¶”ê°€í–ˆìœ¼ë‹ˆ logMessage ì—†ì• ê¸°
      //     }
      //   });
      // // --- banks
      // this.settingListRef()
      //   .doc('banks')
      //   .get()
      //   .then(docSnapshot => {
      //     // documnetê°€ ìˆìœ¼ë©´ update
      //     console.log(docSnapshot);
      //     if (docSnapshot.exists) {
      //       this.settingListRef()
      //         .doc('banks')
      //         .update({ banks: this.saveAsset.banks });

      //       // documentê°€ ì—†ìœ¼ë©´ set
      //     } else {
      //       this.settingListRef()
      //         .doc('banks')
      //         .update({ banks: this.saveAsset.banks });
      //       this.logMassage = ''; // ë°ì´í„°ë¥¼ ì¶”ê°€í–ˆìœ¼ë‹ˆ logMessage ì—†ì• ê¸°
      //     }
      //   });
    },
    // created()ì—ì„œ ì‚¬ìš©í•  í•¨ìˆ˜(ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ ëœ ë°ì´í„° í™”ë©´ì— ë°”ë¡œ ë°˜ì˜ë˜ë„ë¡.)
    getFirebase() {
      // assets
      this.settingListRef()
        .doc('assets')
        .onSnapshot(snapshot => {
          // console.log(snapshot.data().setAsset);
          // documentì˜ ê°’ì´ ìˆìœ¼ë©´
          if (snapshot.exists) {
            const assets = snapshot.data().assets;
            console.log(assets);
            if (assets) {
              this.saveAsset.assets.totalGoal = assets.totalGoal;
              this.saveAsset.assets.cashAsset = assets.cashAsset;
              this.saveAsset.assets.cashGoal = assets.cashGoal;
            }
          }
        });

      // banks
      this.settingListRef()
        .doc('banks')
        .onSnapshot(snapshot => {
          // console.log(snapshot.data().setAsset);
          // documentì˜ ê°’ì´ ìˆìœ¼ë©´
          if (snapshot.exists) {
            const banks = snapshot.data().banks;
            if (banks) {
              this.saveAsset.banks = banks;
              this.bankLength = banks.length;
            }
          }
        });
    },
    // asset ì €ì¥
    saveAssetListForm() {
      this.settingListRef()
        .doc('assets')
        .get()
        .then(doc => {
          console.log(doc);
          // asset docì´ ìˆë‹¤ë©´?
          if (doc.exists) {
            this.settingListRef()
              .doc('assets')
              .update({
                assets: this.saveAsset.assets,
              });

            // asset docì´ ì—†ë‹¤ë©´?
          } else {
            this.settingListRef()
              .doc('assets')
              .set({
                assets: this.saveAsset.assets,
              });
          }
        })
        .catch(err => {
          console.log('ì—¬ê¸°ëŠ” setAsset.vueì—ì„œ saveAssetListForm', err);
        });
    },
    // bank ì €ì¥
    setBankListForm() {
      this.settingListRef()
        .doc('banks')
        .get()
        .then(doc => {
          // banks docì´ ìˆë‹¤ë©´
          if (doc.exists) {
            this.settingListRef()
              .doc('banks')
              .update({
                banks: this.saveAsset.banks,
              });

            // banks docì´ ì—†ë‹¤ë©´
          } else {
            this.settingListRef()
              .doc('banks')
              .set({
                banks: this.saveAsset.banks,
              });
          }
        })
        .catch(err => {
          console.log('SetAsset.vue ì— ìˆëŠ” setBankListForm', err);
        });
    },
    assetAddComma(asset) {
      return addComma(asset);
    },
  },
};
</script>

<style></style>
